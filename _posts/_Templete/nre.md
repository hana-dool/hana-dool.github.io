# 생성 쿼리 이해하기

- 우선

```mysql
SELECT
	*
FROM
	(
	SELECT
		DISTINCT amount ,
		CUME_DIST() OVER(ORDER BY amount) AS cd
	FROM
		payments
	ORDER BY
		amount
	) a
WHERE
	cd >= 0.1 AND cd < 0.2 ;
```

```
amount  |cd                 |
--------+-------------------+
 6419.84|0.10256410256410256|
 6631.36|0.10622710622710622|
 7178.66|0.10989010989010989|
 7310.42|0.11355311355311355|
 7466.32|0.11721611721611722|
 7565.08|0.12087912087912088|
 7612.06|0.12454212454212454|
 7674.94| 0.1282051282051282|
 7678.25|0.13186813186813187|
 8307.28|0.13553113553113552|
 8807.12| 0.1391941391941392|
 9415.13|0.14285714285714285|
 9658.74|0.14652014652014653|
 9821.32|0.15018315018315018|
 9977.85|0.15384615384615385|
10223.83| 0.1575091575091575|
10549.01|0.16117216117216118|
11044.30|0.16483516483516483|
11843.45| 0.1684981684981685|
12081.52|0.17216117216117216|
12190.85|0.17582417582417584|
12432.32| 0.1794871794871795|
12530.51|0.18315018315018314|
12538.01|0.18681318681318682|
12573.28|0.19047619047619047|
12692.19|0.19413919413919414|
13671.82| 0.1978021978021978|
```

- select( max (col) ) 대신에 select * 를 돌리면 위와 같은 예시로 값이 나옵니다.
- 만약 `select(max(amount))` 를 수행하면 아래와 같이 식이 나옵니다.

```
max(amount)|
-----------+
   13671.82|
```

- 위의 값은 Cumulative Density 가 0,1~ 0.2 사이의 값들중 최대를 출력하게 됩니다.

# 이해하기

```sql
SELECT
	*
FROM
	(
	SELECT
		DISTINCT col ,
		CUME_DIST() OVER(ORDER BY col) AS cd
	FROM
		DB 
	ORDER BY
		col
	) a ;
-- DB : 테이블
-- col : 컬럼
```

- 위와 같이 수행하면 다음과 같은 값이 나옵니다.

```
log_count.     |cd                 |
---------------+-------------------+
              1|0.10881174899866489|
              2|0.21194926568758343|
              3|0.30774365821094796|
              4|0.39886515353805074|
              5| 0.4843124165554072|
              6| 0.5637516688918558|
              7| 0.6345126835781041|
              8| 0.7016021361815754|
              9| 0.7606809078771696|
             10| 0.8104138851802403|
             11| 0.8551401869158879|
             12| 0.8931909212283045|
             13| 0.9269025367156208|
             14| 0.9542723631508678|
             15| 0.9732977303070761|
             16| 0.9876502002670227|
             17| 0.9963284379172229|
             18|                1.0|
```

- 이때 `ths = np.arange(0,1,bins_range)` 입니다. 즉 bins_range 의 간격만큼 나눈 list 를 이용하여 위의 분포에서 cd( Cumulitive density) 에 맞는 값을 `th_val` 에 넣게됩니다.

```
Null                     # WHERE cd >= 0 AND cd < 0.1 ;

1|0.10881174899866489|   # WHERE cd >= 0.1 AND cd < 0.2 ;

2|0.21194926568758343|   # WHERE cd >= 0.2 AND cd < 0.3 ;

3|0.30774365821094796|
4|0.39886515353805074|   # WHERE cd >= 0.3 AND cd < 0.4 ;

5| 0.4843124165554072|   # WHERE cd >= 0.4 AND cd < 0.5 ;

6| 0.5637516688918558|   # WHERE cd >= 0.5 AND cd < 0.6 ;

7| 0.6345126835781041|   # WHERE cd >= 0.6 AND cd < 0.7 ;

8| 0.7016021361815754|
9| 0.7606809078771696|   # WHERE cd >= 0.7 AND cd < 0.8 ;

10| 0.8104138851802403|
11| 0.8551401869158879|
12| 0.8931909212283045| # WHERE cd >= 0.8 AND cd < 0.9 ;

13| 0.9269025367156208|
14| 0.9542723631508678|
15| 0.9732977303070761|
16| 0.9876502002670227|
17| 0.9963284379172229| # WHERE cd >= 0.9 AND cd < 1.0 ;
18|                1.0|
```

- 즉 위의 분포는 최종적으로 [0,1,2,4,5,7,9,12,18] 을 생성하게 됩니다.
  - 위 의미는 [0~1] ,(1,2] , (2,4] , (4,5] , (5,7] , (7,9] , (9,12] , (12,17] 을 Binning 으로 형성하겠다는 것입니다.  

