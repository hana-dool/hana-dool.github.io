---
title: "Diagnosing Sample Ratio Mismatch in A/B Testing"
excerpt: "샘플의 분배가 달라지는 경우 어떤일이 생길까?"
categories:
  - AB_Microsoft
last_modified_at: 2021-12-24

toc: true
toc_label: "Table Of Contents"
toc_icon: "cog"
toc_sticky: true

use_math: true
typora-root-url: ../../../../hana-dool.github.io
---

 신뢰성 있는 실험을 하기 위하여 SRM 을 보고 왜 이것을 살펴봐야 하는지에 대해서 알아보자.
{: .notice--warning}

# [SRM](#link){: .btn .btn--primary}{: .align-center}

> ## Introduction

> 2차세계대전의 비행기 관련 분석

- 제2차 세계 대전 중에 콜롬비아 대학의 통계학자인 Abraham Wald 의 분석 예시를 살펴봅시다.
- 그는 군대에서 군인들이 비행 임무에서 살아남을 확률을 높이기 위해서, 비행기에 추가적인 장갑을 어디에 덧댈것인지에 대한 분석을 의뢰받았습니다.
- 군 연구팀과 에이브러햄 통계청은 전투에서 돌아온 항공기의 파손된 부분을 분석해 총알 구멍이 발견된 위치에 주의를 기울였습니다.
  - 군대는 비행기가 가장 많이 총격을 받은 곳에 장갑을 배치할 것을 제안했습니다. 

- 하지만 아브라함은 이러한 접근법 말고 다른 접근법을 통해서 접근했습니다.
  - 그는 항공기의 손상이 가장 적은 부분을 강화할 것을 제안했습니다. 
  - 이러한 해결책이 다소 혼란스럽게 들릴지 모르지만 그의 제안은 정확했습니다.

- 왜냐하면 , 위에서 분석한 비행기는 '살아 돌아온 비행기' 만을 대상으로 분석이 이루어졌기 떄문입니다. 
  - 우리는 살아 돌아온 비행기만 중요한게 아니라 '추락한 비행기' 의 결과도 중요합니다.
  - 즉, 결과를 신뢰할 수 있으려면 돌아오지 않는 비행기도 분석에 포함되어야 했으며, 이러한 분석을 통해서 아브라함은 정확한 분석을 할 수 있었습니다.


> A/B Testing 에서는?

- Abraham Wald 의 예시에서 보듯이 , 추락한 비행기를 고려하지 않고서는 완벽한 분석을 할 수 없었듯이 AB 테스트에서도 똑같은 어려움이 있습니다.
-  A/B 테스트는 종종 Abraham이 그의 분석에서 인식한 것과 동일한 문제인 **생존 편향으로** 인해 어려움을 겪습니다.
- A/B 테스트에서 데이터 불균형은 실험이 시작되기 전에 구성된 Sampling Scheme (예: 50/50 분할) 과 실제로 실험에서 A와 B에서 사용자가 분배된것과 차이가 있다면, 데이터가 불균형 되어있다고 말할 수 있습니다.
- 잠시 후 살펴보겠지만 이러한 불균형 데이터에 대한 분석을 수행하면, 분석에 대한 Truthworthy 가 감소합니다.
  - 이러한 Truthworthy 를 강화하기 위해서 Microsoft에서 모든 A/B 테스트는 영향을 분석하기 전에 먼저 이 SRM(샘플 비율 불일치) 테스트를 통과해야 합니다.

> ## How Do SRMs Impact A/B Tests?

![jpg](/assets/images/Stat/133_1.jpg)

- MSN의 한 팀은 이미지 뷰어의 변경 사항을 테스트한 적이 있습니다. 
  - 이떄 탐색할 수 있는 카드의 수가 12개(A)에서 16개(B)로 증가하면 사용자의 경험(UX) 이 더 좋아질것으로 예상했습니다.
- 이 A/B 테스트는 아주 작은 차이를 검정하기 위해 충분한 통계적 검정력을 가지고 있었고, User 의 user engagement 을 제대로 측정하였습니다.
- 다양한 A/B 테스트 경험에 기대어 봤을때, 이 실험은 무조건 좋은 효과를 불러일으킬 것이라 생각했습니다만, 그 결과는 '감소' 하는것으로 나타났습니다.

> 결과분석

- 이러한 결과는 사실 SRM 경고와 함께 나타난 결과였습니다. 그래서 우리는 심층적으로 조사를 더 실시해 보았고, 그 결과 매우 흥미로운 사실을 발견했습니다. 
  - 이때 사실 B 가 훨씬 좋았던 (즉 '증가') 입니다. 얼마나 상승률이 좋았냐면, 자동 탐지 매커니즘이 B 사용자중 일부를 봇이라고 오인할 정도였습니다.
- 위와 같이 이슈가 해결되었고, 그 결과는 이전과 완전히 달라졌습니다. 
  - 즉 SRM 의 문제가 있으면, 실험의 결과를 완전히 왜곡할수도 있다는 것입니다.
- 그러므로 SRM  의 문제를 해결하기 전에는 , AB Testing 결과를 신뢰하면 안됩니다.

> ## How widespread are SRMs and why do they happen?

- LinkedIn 및 Yahoo 에서는 SRM이 비교적 자주 발생한다고 합니다.
  - LinkedIn에서는 Zoomed - in  A/B 테스트(특정한 조건을 만족시키면, AB 테스트가 발동되는 테스트)의 약 10%가 이러한 편향을 겪었다고 합니다. 
  - Microsoft에서 최근 분석에 따르면 A/B 테스트의 약 6%에 SRM이 있었습니다.
- 이러한 SRM 문제는 때때로 분석 결과를 반대로 왜곡하는 중요한 문제이므로 왜 이러한 현상이 나타나는지 우리는 연구해 보았습니다.
- SRM은 하나의 문제가 아니라 다양한 요인들이 합쳐서 일어나게 됩니다. 
  - 이것은 모든 A/B 실험 계획자들에 대해서 SRM 진단을 매우 어려운 작업으로 만듭니다. 
- Diagnosing Sample Ratio Mismatch KDD'19 paper[4]에서 우리는 SRM의 유형에 대해서 종류를 나누어 보았습니다. 
  - 할당 단계에서 발생하는 SRM의 몇 가지 원인 (예: 잘못된 사용자 버킷팅, 잘못된 사용자 ID, 이월 효과 등), 
  - 실행 단계에서 발생하는 원인 (예: 하나의 변형, 변형에서 사용자 리디렉션) 계약 변경 등), *로그 처리 단계* (예: 잘못된 데이터 조인),
  - 마지막으로*분석 단계* (예: 분석을 분할하기 위해 편향된 조건 사용). 단계와 직교하는 SRM은 *A/B 테스터* 가 실험 변형을 고르지 않게 늘리거나 사용자가 변형에 너무 쉽게 자체 할당하도록 *하여 언제든지 발생할* 수도 있습니다 . 
- 포괄적인 분류는 아래 그림을 참조하거나 당사 보고서를 참조하십시오[4]

![jpg](/assets/images/Stat/133_2.jpg)

- 위와 같은 SRM 에 대한 분류 체계는 , SRM 문제를 좀 더 자세하게 이해할 수 있도록 해줍니다. 하지만 어떤것이 A/B Test 를 편향시키는것인가? 에 대해서는 답해주지 않습니다.
- 다음 절에서는 이러한 방법에 대해서 조사해 봅시다.

> ## How to diagnose SRMs?

- SRM 진단은 두 단계로 이루어집니다. 
  - 1단계는 감지입니다. A/B 테스트에 SRM이 있는지 테스트합니다.
  -  2단계는 진단입니다. 증상을 종합하고, 가능성이 없어보이는 원인을 제거합니다.

>  Does my A/B test have an SRM?

- A/B 플랫폼의 기본 구성소는, A/B 실험기획자들에게 데이터셋의 불일치(mismatch) 에 대해서 결고하는 기능입니다.
  - A/B 테스트에 이러한 기능이 없으면, brower extension  또는 다른 방법을 사용하여, 이러한 SRM Test 를 할 수 있습니다. ([7] L. Vermeer, “Sample Ratio Mismatch (SRM) Checker.” [Online]. Available: https://github.com/lukasvermeer/srm.)
- SRM 테스트는 본격적인 분석을 수행하기 전에 ,A 와 B 의 사용자에 대해서, 잘 나뉘어져 있는지에 대해서 분석하게 됩니다. 
- 이때 직관과는 달리, 오로지 A vs B 의 사용자 비율만 비교하여 테스트하는것으로는 충분하지 않습니다. 
  - 왜냐하면 A 와 B 의 사용자 비율만 보면, ratio 에는 sample size 에 대한 정보가 없기 때문입니다.
- 이러한 SRM 을 테스트 하기 위해서는 chi-square 테스트 등을 수행하여, 관찰된 사용자 분포가, 우리가 실험 전에 정한 분포와 일치하는지의 여부를 확인할 수 있습니다.
- 우리가 위에서 언급했듯이, Exp 를 사용해 진행하는 모든 A/B 테스트는 실제 결과를 공개하기 전에, 이 SRM 테스트를 통과해야 합니다.
  - 이떄 False positive 로 인하여 유의했던 실험을 아예 유의하지 않다! 라고 잘못 말할수도 있으므로, p-value 의 임계값은 0.0005 로 설정합니다. 
- Note : 위의 p-value 가 너무 작아서, SRM 을 탐지 못하실거라고 걱정하실수도 있는데, 실제로 SRM 을 가지는 테스트는 이러한 값보다 훨씬 작은(0.0005) Threshold 를 가지게 됩니다. 

> ## Finding the SRM root cause

- 여기에서 우리는 SRM 을 탐지하는 방법에 대해서 공유해보고자 합니다.

> Segment

- SRM 분석의 일반적인 시작점은 세그먼트 (코호트) 를 분석하는 것입니다. 
- 종종 SRM 의 근본 문제는 특정한 세그먼트에서 문제인 경우가 많습니다.
- 이러한 경우에는 특정 세그먼트에 대해서 A 와 B 그룹이 매우 편향되게 분배되어 있어서 , 테스트 기획자가 좀 더 깊게 파고들게 됩니다.
  - Ex : 예를 들어서. A/B 테스트에서 Treatment 를 적용했을때 특정 브라우저의 경우 웹사이트의 로드 시간을 크게 향상시킨다고 합시다.
  - 이러한 더 빠른 로드 시간은 분석이 기록되고, 수집되는 속도에 영향을 끼칠 수 있습니다.
  - 결과적으로 A/B 테스트에는 이러한 브라우저 세그먼트에 SRM 이 생길 수 있습니다. (이 경우에 다른 세그먼트에 대해서는 문제가.없을 것입니다.)
- 만일 세그먼트에 심각한 SRM 이 일어났는지가 불분명하고, 모든 세그먼트가 SRM 의 영향도가 모두 비슷할떄는 어떻게 해야할까요?

> Triggering

- Assinged 된 population 의 하위 집단 (subet) 에 대해서 A/B 테스트를 진행하는 경우 (Triggered A/B Analysis) , 분석에 사용할 로그를 결정하는데에 사용하는 Bool Condition 을 검사하는것이 좋습니다.
- 일반적으로 A/B 실험 기획자는 Metric 의 민감도를 높히기 위해서 트리거된 분석을 수행합니다. 
  - 예를 들어서 결제 페이지에 Treatment 를 정용하게 될 경우, 이 페이지를 실제로 경험한 사람만 treatment 를 경험하게 되므로 , 결제 페이지를 경험한 사람만 분석하는것이 민감도를 더 높힙니다.
- 하지만 이런 Triggered 된 A/B 테스트를 수행하기 위해서는 결국 유저를 조건에 의해 필터링 해야하는데, 이는 때떄로 특정 Variant 에 대해서는 작동하지 않을 수 있습니다.
  - 예시로 새 쿠폰 코드 필드 추가하는 A/B 테스트를 실시하였고, 필터링은 이 필드에 노출된 사용자를 기준으로 테스트를 했다고 합시다. 
  - 하지만 이때 Control 에 새로운 필드가 없다는것을 명심합시다! 그러므로 이 상태에서 A/B 테스트를 수행하게 된다면 Treatment 의 유저만 샘플이 되기 때문에, 심각한 SRM 을 겪게 됩니다. 
- 이러한 안좋은 조건을 Diagnotic 하기 위한 간단한 방법은 A/B 테스트에서 트리거되지 않은 모집단에 SRM이 없는지 여부를 조사하는 것입니다. (Untriggered Analysis)
  - 즉 이전 예시처럼 새쿠폰 필드에 노출되는것을 Trigger 이라 한다면, Untriggered 모집단 (즉 새 쿠폰에 굳이 노출되지 않은 모든 유저) 에 대해서 SRM 이 있는지 없는지 검사하는 방법입니다. 이를 Untriggered Analyis 라 합니다.
- 즉 Untriggered Analysis 가 SRM 문제가 없고, Triggered Analysis (트리거 된 유저만 이용해 SRM 분석) 를 수행했는데 SRM 문제가 있었다고 합시다. 그러면 이는 Triggered condition 이 문제가 있을 확률이 높습니다.
- 이에 대한 솔루현은 간단합니다. Triggered Condition 을 고쳐서, 모든 유저가 영향을 받게 하세요. 즉 하위 페이지를 개선한 경우, 하위 페이지를 방문한 유저가 아닌, 하위 페이지를 보게 되는 조건을 경험한 유저 로 필터링 해야합니다.
  - ex : 즉 메인페이지 -> 상세 필드에서 help 메뉴를 추가했다고 합시다. 이떄 필터링을 'help 메뉴를 들어간 사람' 으로 filtering 하는게 아니라, '상세필드로 들어간 유저' 으로 filtering 하세요 
- 물론 여기에 더 많은 정보를 수집하기 위해서 몇가지 다른 Diagnostic Steps 가 있습니다. 
- 물론 아래와 같이 A/B 테스터가 자신의 SRM 을 진단하는데에 몇가지 진단 기준이 더 있습니다.
  - p-value 가 매우 낮으면 심각한 root cause (근본 원인) 을 나타냄
  - SRM 의 방향성 (예상되는 유저수에 비해 훨씬 더 많은 유저가 참가하고나, 성능이 너무 향상)
  - SRM 의 수가 많을수록 심각한 문제, 특히 동시다발적으로 SRM 이 일어나면 , 이는 데이터 파이프라인의 이슈 일 수 있음 

> ## What tools help with the diagnosis?

- ExP에서는 위에서 논의한 원인에 대한 SRM을 진단하는 데 도움이 되는 Tool을 개발했습니다. 
- 이 Tool 을 사용자는 일련의 자동화된 검사 등을 통하여 A/B 테스터는 SRM 분석에 대해서 다음과 같은 질문에 대한 답을 얻을 수 있습니다.
  - SRM이 일부 세그먼트에 국한되어있거나, 모든 세그먼트에 넓게 퍼져 있습니까?
  - 트리거를 위해 구성된 Bool Condition 으로 인해 SRM이 발생했습니까?
  - A/B 테스트 시작부터 SRM 근본 원인(root-cause) 이 존재했습니까?
- 이후에 이러한 질문들에 대해서 어떻게 답할 수 있을지에 대해서 알아보겠습니다.

> ## Is the SRM localized to some segments or widespread?

- A/B 테스터에게 SRM 이 Localized (즉 일부 세그먼트에 국한) 되어 있는지 , 널리 퍼져있는지에 대해 통찰력을 제공하기 위해서, 사용 가능한 모든 세그먼트가 셀로 표현되는 직관적인 시각화를 제공합니다.

![jpg](/assets/images/Stat/133_3.jpg)

- 위에서 빨간색 셀은 SRM을 나타내고 회색 셀은 해당 세그먼트에 대해 SRM이 감지되지 않았음을 나타냅니다. 
- 셀의 크기는 세그먼트의 크기에 비례합니다. 큰 셀은 큰 세그먼트를 가리키고 그 반대도 마찬가지입니다. 
- 이 시각화의 사용자는 SRM p-값의 Threshold 를 조절하면서 얼마나 확실하게 SRM 을 나타내고 있는지를 알 수 있습니다.
- 또한 세그먼트 크기를 기반으로 뷰를 필터링할 수도 있습니다 
- 위에서 설명한 것처럼 이런 시각화와 필터링을 통한 목표는 SRM이 일부 세그먼트에서만 감지되었는지 여부와, SRM 문제가  전체 분석을 왜곡할 만큼 충분히 큰지 여부를 찾는 것입니다.

> ## Was the SRM caused by the configured condition?

![jpg](/assets/images/Stat/133_3.jpg)

- zoomed-in A/B 분석(특정한 하위 집단에 대한 AB 테스트)의 경우, Zooming condition 이 SRM 의 근본 원인인지 아닌지 검정하는 기능도 제공합니다
- 위에서 설명했었던 대로, 주어진 A/B 테스트에 대해 이 조건을 사용하지 않은 근본 원인인지 여부에 대한 진단 정보를 제공합니다. 
- 이렇게 condition 을 없앤 분석에 SRM이 없을 때마다, 분석을 생성하는 데 사용된 조건을 디버그하도록 요청합니다. (즉 condition 이 없는 유저에 대해서 SRM 이 발생하지 않았는데 , 필터링된 유저에 대해서 SRM 이 발생했다는것은 조건의 문제일 확률이 크기 떄문이죠)

> Historical Data

- 위에서 설명한 검사 이외에도, 실험의 과거 데이터를 이용해 SRM 의 근본원인이 발생한 시간을 결정하는 검사도 개발했습니다.
- 이 기능에 대해서는 다른 게시물에서 다루도록 하겠습니다.

> Simpe Questions

- 또한 우리는 SRM 진단시 표준화된 여러 질문들을 통해 , 질문에 답하게 되면 답변을 바탕으로 SRM 의 사례 연구나 분류체계로 연결되어 안내하기도 합니다.

> ## Conclusion

- Exp 의 목적은 신뢰할 수 있는 온라인 통제 실험을 제공하는 것입니다.
- 샘플 비율 불일치(SRM)는 A/B 테스트 결과를 신뢰할 수 있으려면 먼저 감지, 진단 및 해결해야 합니다. 
